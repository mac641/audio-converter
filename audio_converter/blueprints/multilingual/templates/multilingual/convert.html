{% extends "base.html" %}

{% block head %}
    {% block styles %}
        {{ dropzone.load_css() }}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/convert.css') }}">
    {% endblock styles %}
{% endblock head %}

{% block content %}
    {{ dropzone.create(action='multilingual.convert_upload') }}
    <label id="convert-audio-file-format-label">{{ _('Destination file format') }}:</label>
    <select name="convert-audio-file-format-select" id="convert-audio-file-format-select">
        {% for file_type in allowed_audio_file_types %}
            <option value="{{ file_type }}">{{ file_type }}</option>
        {% endfor %}
    </select>
    <button id="upload-convert-submit"
            title="Note, in case you upload files which have been converted already, the server will ignore them.">
        {{ _('Upload And Convert') }}
    </button>

    {{ dropzone.load_js() }}
    {{ dropzone.config(custom_init='dz = this;
        document.getElementById("upload-convert-submit").addEventListener("click", e => {
            if (e.button !== 0) return;
            dz.processQueue();
            handleConvert();
        });
        window.addEventListener("keydown", e => {
            if (e.key !== "Enter") return;
            dz.processQueue();
            handleConvert();
        });',
    custom_options='autoProcessQueue: false, createImageThumbnails: false, disablePreviews: true') }}

    <script type="text/javascript">
        function handleConvert() {
            const fileType = document.getElementById('convert-audio-file-format-select').value;

            // TODO: display loading screen
            fetch("{{ url_for('multilingual.convert_process') }}", {
                headers: {
                    'Content-Type': 'text/plain'
                },
                method: 'POST',
                body: `${fileType}`
            }).then((res) => {
                console.log(res);
                if (res.status === 301 || res.status === 200) {
                    /*
                    // NOTE: This has been added as button hover title
                    window.alert('Files received for processing!\n\n' +
                        'In case you\'ve uploaded files which have been converted already,' +
                        'the server will skip them.\n\n' +
                        'Press OK to continue...');
                    */
                    window.location.replace(res.url);
                    return;
                }
                res.text().then(value => {
                    // TODO: Delete files from server, if conversion fails
                    window.alert('The server ran into an error converting your files!\n\n' +
                        `${value}\n\n` + 'Press OK to be redirected to the start page...');
                    window.location.replace("{{ url_for('multilingual.index') }}");
                });
            });
        }
    </script>
{% endblock %}